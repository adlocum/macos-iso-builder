name: Build macOS Installer ISO/DMG image

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Tahoe'
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
          - 'Sierra'
          - 'El Capitan'
          - 'Yosemite'
          - 'Mavericks'
          - 'Mountain Lion'
          - 'Lion'
      image_format:
        description: 'Select image format: iso for virtual machines, dmg for burning to USB drive'
        required: true
        type: choice
        options:
          - 'iso'
          - 'dmg'

permissions:
  contents: write   # required for GitHub Release

jobs:
  build-installer:
    runs-on: macos-15-intel
    timeout-minutes: 70

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "Runner OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          echo "Available disk space:"
          df -h
          echo "Memory:"
          top -l 1 | grep PhysMem

      - name: Create Image
        id: create_image
        run: |
          if [ "${{ github.event.inputs.image_format }}" == "iso" ]; then
            echo "Creating macOS ${{ github.event.inputs.macos_version }} ISO image"
            bash mkmaciso "${{ github.event.inputs.macos_version }}"
            IMAGE_NAME=$(basename *.iso)
          else
            echo "Creating macOS ${{ github.event.inputs.macos_version }} DMG image"
            bash mkmaciso "${{ github.event.inputs.macos_version }}" dmg
            IMAGE_NAME=$(basename *.dmg)
          fi

          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # CI artifact (keep for troubleshooting / short-term)
      # --------------------------------------------------
      - name: Upload ISO artifact
        if: github.event.inputs.image_format == 'iso'
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.create_image.outputs.image_name }}
          path: ./*.iso
          compression-level: 0
          retention-days: 5

      - name: Upload DMG artifact
        if: github.event.inputs.image_format == 'dmg'
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.create_image.outputs.image_name }}
          path: ./*.dmg
          compression-level: 0
          retention-days: 5

      # --------------------------------------------------
      # GitHub Release (FAST download, recommended)
      # --------------------------------------------------
      - name: Create GitHub Release and upload image
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.macos_version }}-${{ github.event.inputs.image_format }}-${{ github.run_number }}
          name: macOS ${{ github.event.inputs.macos_version }} (${{ github.event.inputs.image_format }})
          body: |
            macOS version: ${{ github.event.inputs.macos_version }}
            Image format: ${{ github.event.inputs.image_format }}

            This image is built automatically by GitHub Actions.

            Recommended download methods:
            - aria2 (multi-thread, resumable)
            - wget / curl

            Example (aria2):
            aria2c -x 16 -s 16 <download-url>

          files: |
            *.iso
            *.dmg

      - name: Summary
        run: |
          echo "## ✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.create_image.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download recommendation:**" >> $GITHUB_STEP_SUMMARY
          echo "- Use GitHub Release for fast, resumable downloads" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found this useful? Give it a ⭐ star so others can find it too!" >> $GITHUB_STEP_SUMMARY
