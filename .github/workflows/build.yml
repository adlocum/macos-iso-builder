name: Build macOS Installer ISO/DMG image

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Tahoe'
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
          - 'Sierra'
          - 'El Capitan'
          - 'Yosemite'
          - 'Mavericks'
          - 'Mountain Lion'
          - 'Lion'
      image_format:
        description: 'Select image format: iso for virtual machines, dmg for USB install'
        required: true
        type: choice
        options:
          - 'iso'
          - 'dmg'

jobs:
  build-installer:
    runs-on: macos-15-intel
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "Runner OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          echo "Disk space:"
          df -h
          echo "Memory:"
          top -l 1 | grep PhysMem

      - name: Create macOS Image
        id: create_image
        run: |
          if [ "${{ github.event.inputs.image_format }}" = "iso" ]; then
            echo "Creating macOS ${{ github.event.inputs.macos_version }} ISO"
            bash mkmaciso "${{ github.event.inputs.macos_version }}"
            FILE=$(ls *.iso)
          else
            echo "Creating macOS ${{ github.event.inputs.macos_version }} DMG"
            bash mkmaciso "${{ github.event.inputs.macos_version }}" dmg
            FILE=$(ls *.dmg)
          fi

          echo "image_name=$FILE" >> $GITHUB_OUTPUT
          echo "file_size=$(du -h "$FILE" | cut -f1)" >> $GITHUB_OUTPUT
          shasum -a 256 "$FILE" | awk '{print $1}' > sha256.txt

      # -------- Tencent COS Upload --------

      - name: Install coscli
        run: |
          curl -L https://github.com/tencentyun/coscli/releases/latest/download/coscli-darwin-amd64 -o coscli
          chmod +x coscli
          sudo mv coscli /usr/local/bin/coscli

      - name: Configure coscli
        run: |
          coscli config set \
            --secret_id ${{ secrets.COS_SECRET_ID }} \
            --secret_key ${{ secrets.COS_SECRET_KEY }} \
            --bucket ${{ secrets.COS_BUCKET }} \
            --region ${{ secrets.COS_REGION }}

      - name: Upload image to Tencent COS
        run: |
          FILE="${{ steps.create_image.outputs.image_name }}"
          coscli upload "$FILE" macos/ \
            --part-size 128 \
            --parallel 4

      # -------- Job Summary --------

      - name: Summary
        run: |
          FILE="${{ steps.create_image.outputs.image_name }}"
          SIZE="${{ steps.create_image.outputs.file_size }}"
          SHA256=$(cat sha256.txt)

          echo "## ✅ Successfully built macOS image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** $FILE" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256:** \`$SHA256\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⬇️ **Download (Tencent COS):**" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ secrets.COS_BUCKET }}.cos.${{ secrets.COS_REGION }}.myqcloud.com/macos/$FILE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> This image is intended for Proxmox VE, QEMU, VMware, VirtualBox or USB installation." >> $GITHUB_STEP_SUMMARY
